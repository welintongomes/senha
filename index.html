<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofre de Senhas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@600;800&display=swap');
        
        :root {
            --bg-dark: #0a0e27;
            --bg-mid: #151b3d;
            --bg-light: #1f2949;
            --accent-cyan: #00f0ff;
            --accent-purple: #bf00ff;
            --accent-green: #00ff88;
            --text-primary: #e8f4f8;
            --text-secondary: #8b9fc9;
            --border: rgba(0, 240, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 240, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-family: 'Syne', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-cyan);
            animation: pulse 2s ease-in-out infinite;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 240, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(191, 0, 255, 0.1) 0%, transparent 50%);
            animation: drift 20s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes drift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(5deg); }
            66% { transform: translate(-20px, 20px) rotate(-5deg); }
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            position: relative;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .container.visible {
            opacity: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.6s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header h1 {
            font-family: 'Syne', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -2px;
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .lock-screen, .vault-screen {
            background: var(--bg-mid);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        
        .lock-screen {
            animation: fadeIn 0.6s ease-out 0.2s backwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .vault-screen {
            display: none;
        }
        
        .vault-screen.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }
        
        .lock-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .input-group {
            margin-bottom: 24px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        input, textarea {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1);
        }
        
        input::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Syne', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 240, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-mid);
            box-shadow: 0 4px 16px rgba(0, 240, 255, 0.2);
        }
        
        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 0.85rem;
            display: inline-block;
            margin-right: 8px;
        }
        
        .vault-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .vault-header h2 {
            font-family: 'Syne', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-cyan);
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .controls .btn-small {
            flex: 1 1 auto;
            min-width: 120px;
        }
        
        .search-box {
            width: 100%;
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box input {
            padding-left: 45px;
            background: var(--bg-light);
            border: 1px solid var(--border);
        }
        
        .search-box input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--text-secondary);
            pointer-events: none;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
        }
        
        .pagination button {
            padding: 8px 16px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--bg-mid);
            border-color: var(--accent-cyan);
        }
        
        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .pagination span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .stats {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 15px;
        }
        
        .password-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .password-item {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .password-item:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 4px 16px rgba(0, 240, 255, 0.15);
        }
        
        .password-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .password-item-title {
            font-weight: 700;
            color: var(--accent-cyan);
            font-size: 1.1rem;
        }
        
        .password-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .icon-btn:hover {
            background: var(--bg-mid);
            color: var(--accent-cyan);
        }
        
        .password-item-info {
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.6;
        }
        
        .password-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            display: inline-block;
        }
        
        .hidden {
            display: none;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: var(--bg-mid);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 16px 48px rgba(0, 240, 255, 0.2);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent-cyan);
        }
        
        .error {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            color: #ff6b6b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        
        .success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        
        /* Scrollbar customization */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-purple);
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .lock-screen, .vault-screen {
                padding: 24px;
            }
            
            .vault-header {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .vault-header h2 {
                text-align: center;
                font-size: 1.4rem;
            }
            
            .controls {
                width: 100%;
            }
            
            .controls .btn-small {
                flex: 1 1 calc(50% - 5px);
                min-width: 0;
            }
            
            .password-item {
                padding: 12px;
            }
            
            .password-item-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .password-item-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .pagination {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .pagination button {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .pagination span {
                width: 100%;
                text-align: center;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Inicializando Cofre...</div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üîê COFRE</h1>
            <p>Gerenciador de Senhas Criptografado</p>
        </div>
        
        <!-- Tela de Login -->
        <div id="lockScreen" class="lock-screen">
            <div class="lock-icon">üîí</div>
            <div id="lockError"></div>
            <div class="input-group">
                <label for="masterPassword">Chave Mestra</label>
                <input type="password" id="masterPassword" placeholder="Digite sua chave mestra" autocomplete="off">
            </div>
            <button class="btn" onclick="unlockVault()">Desbloquear Cofre</button>
        </div>
        
        <!-- Tela do Cofre -->
        <div id="vaultScreen" class="vault-screen">
            <div class="vault-header">
                <h2>üîì Cofre Desbloqueado</h2>
                <button class="btn btn-secondary btn-small" onclick="lockVault()">Bloquear</button>
            </div>
            
            <div class="controls">
                <button class="btn btn-secondary btn-small" onclick="showAddModal()">‚ûï Adicionar</button>
                <button class="btn btn-secondary btn-small" onclick="exportPasswords()">‚¨áÔ∏è Exportar</button>
                <button class="btn btn-secondary btn-small" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Importar</button>
                <button class="btn btn-secondary btn-small" onclick="clearAllData()" style="color: #ff6b6b;">üóëÔ∏è Limpar Tudo</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importPasswords(event)">
            </div>
            
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Buscar senhas..." oninput="searchPasswords()">
            </div>
            
            <div class="stats" id="statsDisplay"></div>
            
            <div id="passwordList" class="password-list"></div>
            
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
    
    <!-- Modal para Adicionar/Editar Senha -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Nova Senha</div>
            <div id="modalError"></div>
            <div class="input-group">
                <label for="modalTitle">T√≠tulo</label>
                <input type="text" id="modalTitle" placeholder="Ex: Email, Netflix, Banco">
            </div>
            <div class="input-group">
                <label for="modalUsername">Usu√°rio/Email</label>
                <input type="text" id="modalUsername" placeholder="usuario@email.com">
            </div>
            <div class="input-group">
                <label for="modalPassword">Senha</label>
                <input type="text" id="modalPassword" placeholder="Sua senha">
            </div>
            <div class="input-group">
                <label for="modalNotes">Notas (opcional)</label>
                <textarea id="modalNotes" rows="3" placeholder="Informa√ß√µes adicionais"></textarea>
            </div>
            <button class="btn" onclick="savePassword()">Salvar</button>
            <button class="btn btn-secondary" onclick="closeModal()" style="margin-top: 10px;">Cancelar</button>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let masterKey = null;
        let db = null;
        let currentEditId = null;
        let allPasswords = [];
        let filteredPasswords = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Inicializar IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                // Verificar se IndexedDB est√° dispon√≠vel
                if (!window.indexedDB) {
                    reject(new Error('IndexedDB n√£o est√° dispon√≠vel neste navegador'));
                    return;
                }
                
                const request = indexedDB.open('PasswordVault', 1);
                
                request.onerror = () => {
                    console.error('Erro ao abrir IndexedDB:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB inicializado com sucesso');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('passwords')) {
                        const objectStore = db.createObjectStore('passwords', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('title', 'title', { unique: false });
                        console.log('Banco de dados criado');
                    }
                };
                
                // Timeout de seguran√ßa
                setTimeout(() => {
                    if (!db) {
                        reject(new Error('Timeout ao inicializar banco de dados'));
                    }
                }, 5000);
            });
        }

        // Fun√ß√µes de criptografia usando Web Crypto API
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );
            
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encrypt(text, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );
            
            // Combinar IV e dados criptografados
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            
            return btoa(String.fromCharCode(...combined));
        }

        async function decrypt(encryptedData, key) {
            try {
                const combined = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
                const iv = combined.slice(0, 12);
                const data = combined.slice(12);
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                
                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            } catch (e) {
                throw new Error('Falha na descriptografia');
            }
        }

        // Desbloquear cofre
        async function unlockVault() {
            const password = document.getElementById('masterPassword').value;
            
            if (!password) {
                showError('lockError', 'Digite a chave mestra');
                return;
            }
            
            try {
                // Usar um salt fixo (em produ√ß√£o, armazenar salt por usu√°rio)
                const salt = new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]);
                masterKey = await deriveKey(password, salt);
                
                // Testar a chave tentando carregar senhas
                await loadPasswords();
                
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('vaultScreen').classList.add('active');
                document.getElementById('masterPassword').value = '';
            } catch (error) {
                showError('lockError', 'Chave mestra incorreta ou erro ao carregar');
                console.error(error);
            }
        }

        // Bloquear cofre
        function lockVault() {
            masterKey = null;
            document.getElementById('vaultScreen').classList.remove('active');
            document.getElementById('lockScreen').style.display = 'block';
            document.getElementById('passwordList').innerHTML = '';
            
            // Limpar dados em mem√≥ria
            allPasswords = [];
            filteredPasswords = [];
            
            // Limpar busca
            document.getElementById('searchInput').value = '';
            
            // Remover banner de aviso se existir
            const warningBanner = document.getElementById('warningBanner');
            if (warningBanner) warningBanner.remove();
        }

        // Carregar senhas
        async function loadPasswords() {
            if (!db) await initDB();
            
            const transaction = db.transaction(['passwords'], 'readonly');
            const objectStore = transaction.objectStore('passwords');
            const request = objectStore.getAll();
            
            request.onsuccess = async () => {
                const passwords = request.result;
                allPasswords = [];
                let failedItems = 0;
                
                // Descriptografar todas as senhas
                for (const item of passwords) {
                    try {
                        allPasswords.push({
                            id: item.id,
                            title: await decrypt(item.title, masterKey),
                            username: await decrypt(item.username, masterKey),
                            password: await decrypt(item.password, masterKey),
                            notes: item.notes ? await decrypt(item.notes, masterKey) : '',
                            timestamp: item.timestamp
                        });
                    } catch (e) {
                        failedItems++;
                        console.warn('Item n√£o pode ser descriptografado (chave incorreta):', item.id);
                    }
                }
                
                // Alerta se houver itens que n√£o puderam ser descriptografados
                if (failedItems > 0) {
                    showWarningBanner(failedItems);
                }
                
                // Ordenar por t√≠tulo
                allPasswords.sort((a, b) => a.title.localeCompare(b.title));
                
                // Aplicar filtro de busca se houver
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                if (searchTerm) {
                    filteredPasswords = allPasswords.filter(item => 
                        item.title.toLowerCase().includes(searchTerm) ||
                        item.username.toLowerCase().includes(searchTerm) ||
                        item.notes.toLowerCase().includes(searchTerm)
                    );
                } else {
                    filteredPasswords = [...allPasswords];
                }
                
                currentPage = 1;
                renderPasswords();
            };
        }
        
        // Mostrar aviso sobre itens n√£o descriptografados
        function showWarningBanner(count) {
            // Remover banner existente primeiro
            const existingBanner = document.getElementById('warningBanner');
            if (existingBanner) existingBanner.remove();
            
            // S√≥ mostrar se realmente houver itens com problema
            if (count === 0) return;
            
            const banner = document.createElement('div');
            banner.id = 'warningBanner';
            banner.style.cssText = `
                background: rgba(255, 193, 7, 0.15);
                border: 1px solid rgba(255, 193, 7, 0.4);
                color: #ffc107;
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 16px;
                font-size: 0.9rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                animation: slideIn 0.3s ease-out;
            `;
            banner.innerHTML = `
                <div>
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> ${count} senha(s) n√£o puderam ser descriptografadas. 
                    Isso geralmente acontece quando voc√™ tem dados de testes antigos ou mudou a chave mestra.
                    <button class="btn btn-secondary btn-small" style="margin-left: 10px; padding: 4px 12px;" onclick="showCleanupOptions()">
                        üßπ Remover Corrompidas
                    </button>
                </div>
                <button class="icon-btn" onclick="this.parentElement.remove()" style="font-size: 1.2rem;">‚úï</button>
            `;
            
            const searchBox = document.querySelector('.search-box');
            searchBox.parentNode.insertBefore(banner, searchBox.nextSibling);
        }
        
        // Op√ß√µes de limpeza
        function showCleanupOptions() {
            const confirmed = confirm(
                'üßπ LIMPEZA DO BANCO DE DADOS\n\n' +
                'Deseja remover as senhas que n√£o podem ser descriptografadas?\n\n' +
                '‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o √© PERMANENTE!\n\n' +
                'Apenas senhas corrompidas ou criptografadas com outra chave mestra ser√£o removidas.\n' +
                'Suas senhas acess√≠veis permanecer√£o intactas.\n\n' +
                'Clique OK para continuar ou Cancelar para manter tudo como est√°.'
            );
            
            if (confirmed) {
                cleanupCorruptedPasswords();
            }
        }
        
        // Limpar todos os dados
        function clearAllData() {
            const confirmed = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO: A√á√ÉO IRREVERS√çVEL!\n\n' +
                'Voc√™ est√° prestes a APAGAR TODAS as senhas do banco de dados.\n\n' +
                'üî¥ TODOS os dados ser√£o perdidos permanentemente!\n' +
                'üî¥ Esta a√ß√£o N√ÉO pode ser desfeita!\n\n' +
                'üí° Recomenda√ß√£o: Fa√ßa um backup (Exportar) antes de continuar.\n\n' +
                'Deseja realmente apagar tudo?'
            );
            
            if (!confirmed) return;
            
            const doubleConfirm = confirm(
                '‚ö†Ô∏è √öLTIMA CONFIRMA√á√ÉO!\n\n' +
                'Tem ABSOLUTA CERTEZA que deseja apagar todas as senhas?\n\n' +
                'Digite OK para confirmar.'
            );
            
            if (!doubleConfirm) return;
            
            const transaction = db.transaction(['passwords'], 'readwrite');
            const objectStore = transaction.objectStore('passwords');
            const clearRequest = objectStore.clear();
            
            clearRequest.onsuccess = () => {
                alert('‚úÖ Todos os dados foram apagados com sucesso.');
                allPasswords = [];
                filteredPasswords = [];
                renderPasswords();
            };
            
            clearRequest.onerror = () => {
                alert('‚ùå Erro ao limpar o banco de dados.');
            };
        }
        
        // Limpar senhas corrompidas
        async function cleanupCorruptedPasswords() {
            const transaction = db.transaction(['passwords'], 'readwrite');
            const objectStore = transaction.objectStore('passwords');
            const request = objectStore.getAll();
            
            request.onsuccess = async () => {
                const passwords = request.result;
                let removed = 0;
                
                for (const item of passwords) {
                    try {
                        // Tentar descriptografar
                        await decrypt(item.title, masterKey);
                        await decrypt(item.username, masterKey);
                        await decrypt(item.password, masterKey);
                    } catch (e) {
                        // Se falhar, remover do banco
                        const deleteTransaction = db.transaction(['passwords'], 'readwrite');
                        const deleteStore = deleteTransaction.objectStore('passwords');
                        deleteStore.delete(item.id);
                        removed++;
                    }
                }
                
                setTimeout(() => {
                    alert(`‚úÖ Limpeza conclu√≠da!\n\n${removed} senha(s) corrompida(s) foram removidas.`);
                    loadPasswords();
                }, 500);
            };
        }
        
        // Renderizar senhas com pagina√ß√£o
        function renderPasswords() {
            const list = document.getElementById('passwordList');
            const statsDisplay = document.getElementById('statsDisplay');
            const pagination = document.getElementById('pagination');
            
            list.innerHTML = '';
            
            if (filteredPasswords.length === 0) {
                if (allPasswords.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Nenhuma senha salva ainda. Clique em "Adicionar" para come√ßar.</p>';
                } else {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">Nenhuma senha encontrada na busca.</p>';
                }
                statsDisplay.innerHTML = '';
                pagination.innerHTML = '';
                return;
            }
            
            // Calcular pagina√ß√£o
            const totalPages = Math.ceil(filteredPasswords.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredPasswords.length);
            const currentItems = filteredPasswords.slice(startIndex, endIndex);
            
            // Mostrar estat√≠sticas
            statsDisplay.innerHTML = `Mostrando ${startIndex + 1}-${endIndex} de ${filteredPasswords.length} senhas`;
            
            // Renderizar itens da p√°gina atual
            currentItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'password-item';
                div.style.animationDelay = `${index * 0.05}s`;
                div.innerHTML = `
                    <div class="password-item-header">
                        <div class="password-item-title">${escapeHtml(item.title)}</div>
                        <div class="password-item-actions">
                            <button class="icon-btn" onclick="copyToClipboard('${escapeHtml(item.username)}', this)" title="Copiar usu√°rio">üë§</button>
                            <button class="icon-btn" onclick="copyToClipboard('${escapeHtml(item.password)}', this)" title="Copiar senha">üìã</button>
                            <button class="icon-btn" onclick="editPassword(${item.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deletePassword(${item.id})" title="Deletar">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="password-item-info">
                        <div><strong>Usu√°rio:</strong> ${escapeHtml(item.username)}</div>
                        <div><strong>Senha:</strong> <span class="password-value">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span> <button class="icon-btn" onclick="togglePassword(this, '${escapeHtml(item.password)}')">üëÅÔ∏è</button></div>
                        ${item.notes ? `<div><strong>Notas:</strong> ${escapeHtml(item.notes)}</div>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Renderizar controles de pagina√ß√£o
            if (totalPages > 1) {
                pagination.innerHTML = `
                    <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>‚èÆÔ∏è</button>
                    <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚óÄÔ∏è</button>
                    <span>P√°gina ${currentPage} de ${totalPages}</span>
                    <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚ñ∂Ô∏è</button>
                    <button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>‚è≠Ô∏è</button>
                `;
            } else {
                pagination.innerHTML = '';
            }
        }
        
        // Mudar p√°gina
        function changePage(page) {
            currentPage = page;
            renderPasswords();
            document.getElementById('passwordList').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Buscar senhas
        function searchPasswords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm) {
                filteredPasswords = allPasswords.filter(item => 
                    item.title.toLowerCase().includes(searchTerm) ||
                    item.username.toLowerCase().includes(searchTerm) ||
                    item.notes.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredPasswords = [...allPasswords];
            }
            
            currentPage = 1;
            renderPasswords();
        }

        // Mostrar/esconder senha
        function togglePassword(btn, password) {
            const span = btn.previousElementSibling;
            if (span.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                span.textContent = password;
                btn.textContent = 'üôà';
            } else {
                span.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        // Copiar para clipboard
        async function copyToClipboard(text, btn) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ';
                setTimeout(() => btn.textContent = originalText, 2000);
            } catch (e) {
                alert('Erro ao copiar');
            }
        }

        // Mostrar modal de adicionar
        function showAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').value = '';
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalNotes').value = '';
            document.getElementById('passwordModal').classList.add('active');
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('modalError').innerHTML = '';
        }

        // Salvar senha
        async function savePassword() {
            const title = document.getElementById('modalTitle').value;
            const username = document.getElementById('modalUsername').value;
            const password = document.getElementById('modalPassword').value;
            const notes = document.getElementById('modalNotes').value;
            
            if (!title || !username || !password) {
                showError('modalError', 'Preencha t√≠tulo, usu√°rio e senha');
                return;
            }
            
            try {
                const encryptedData = {
                    title: await encrypt(title, masterKey),
                    username: await encrypt(username, masterKey),
                    password: await encrypt(password, masterKey),
                    notes: notes ? await encrypt(notes, masterKey) : '',
                    timestamp: Date.now()
                };
                
                const transaction = db.transaction(['passwords'], 'readwrite');
                const objectStore = transaction.objectStore('passwords');
                
                if (currentEditId) {
                    encryptedData.id = currentEditId;
                    objectStore.put(encryptedData);
                } else {
                    objectStore.add(encryptedData);
                }
                
                transaction.oncomplete = () => {
                    closeModal();
                    loadPasswords();
                };
            } catch (error) {
                showError('modalError', 'Erro ao salvar senha');
                console.error(error);
            }
        }

        // Editar senha
        async function editPassword(id) {
            const item = allPasswords.find(p => p.id === id);
            if (!item) {
                alert('Senha n√£o encontrada');
                return;
            }
            
            currentEditId = id;
            document.getElementById('modalTitle').value = item.title;
            document.getElementById('modalUsername').value = item.username;
            document.getElementById('modalPassword').value = item.password;
            document.getElementById('modalNotes').value = item.notes;
            document.getElementById('passwordModal').classList.add('active');
        }

        // Deletar senha
        function deletePassword(id) {
            if (!confirm('Tem certeza que deseja deletar esta senha?')) return;
            
            const transaction = db.transaction(['passwords'], 'readwrite');
            const objectStore = transaction.objectStore('passwords');
            objectStore.delete(id);
            
            transaction.oncomplete = () => loadPasswords();
        }

        // Exportar senhas
        async function exportPasswords() {
            // Solicitar senha para o arquivo de exporta√ß√£o
            const exportPassword = prompt('üîê Defina uma senha para proteger o arquivo de exporta√ß√£o:\n\n(Esta senha ser√° necess√°ria para importar o arquivo)');
            
            if (!exportPassword) {
                alert('Exporta√ß√£o cancelada');
                return;
            }
            
            if (exportPassword.length < 6) {
                alert('A senha deve ter no m√≠nimo 6 caracteres');
                return;
            }
            
            const transaction = db.transaction(['passwords'], 'readonly');
            const objectStore = transaction.objectStore('passwords');
            const request = objectStore.getAll();
            
            request.onsuccess = async () => {
                const passwords = request.result;
                
                // Descriptografar tudo para exporta√ß√£o
                const decrypted = [];
                for (const item of passwords) {
                    try {
                        decrypted.push({
                            title: await decrypt(item.title, masterKey),
                            username: await decrypt(item.username, masterKey),
                            password: await decrypt(item.password, masterKey),
                            notes: item.notes ? await decrypt(item.notes, masterKey) : '',
                            timestamp: item.timestamp
                        });
                    } catch (e) {
                        console.error('Erro ao descriptografar para exporta√ß√£o:', e);
                    }
                }
                
                // Criptografar o arquivo de exporta√ß√£o
                const dataStr = JSON.stringify(decrypted);
                const exportSalt = crypto.getRandomValues(new Uint8Array(16));
                const exportKey = await deriveKey(exportPassword, exportSalt);
                const encryptedExport = await encrypt(dataStr, exportKey);
                
                // Incluir o salt no arquivo
                const exportData = {
                    version: 1,
                    salt: btoa(String.fromCharCode(...exportSalt)),
                    data: encryptedExport,
                    timestamp: new Date().toISOString()
                };
                
                const exportStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([exportStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `senhas-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Backup criado com sucesso!\n\n‚ö†Ô∏è Guarde a senha em local seguro - voc√™ precisar√° dela para importar.');
            };
        }

        // Importar senhas
        async function importPasswords(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const fileData = JSON.parse(e.target.result);
                    
                    let data;
                    
                    // Verificar se √© arquivo criptografado (novo formato)
                    if (fileData.version === 1 && fileData.salt && fileData.data) {
                        const importPassword = prompt('üîê Digite a senha do arquivo de backup:');
                        
                        if (!importPassword) {
                            alert('Importa√ß√£o cancelada');
                            return;
                        }
                        
                        try {
                            // Descriptografar o arquivo
                            const salt = Uint8Array.from(atob(fileData.salt), c => c.charCodeAt(0));
                            const importKey = await deriveKey(importPassword, salt);
                            const decryptedStr = await decrypt(fileData.data, importKey);
                            data = JSON.parse(decryptedStr);
                        } catch (error) {
                            alert('‚ùå Senha incorreta ou arquivo corrompido');
                            return;
                        }
                    } 
                    // Suporte para arquivos antigos n√£o criptografados
                    else if (Array.isArray(fileData)) {
                        const confirm = window.confirm('‚ö†Ô∏è ATEN√á√ÉO: Este arquivo N√ÉO est√° criptografado!\n\nSuas senhas est√£o vis√≠veis em texto simples.\nDeseja continuar a importa√ß√£o?');
                        if (!confirm) return;
                        data = fileData;
                    } else {
                        alert('Formato de arquivo inv√°lido');
                        return;
                    }
                    
                    if (!Array.isArray(data)) {
                        alert('Formato de arquivo inv√°lido');
                        return;
                    }
                    
                    const transaction = db.transaction(['passwords'], 'readwrite');
                    const objectStore = transaction.objectStore('passwords');
                    
                    let imported = 0;
                    for (const item of data) {
                        try {
                            const encryptedData = {
                                title: await encrypt(item.title, masterKey),
                                username: await encrypt(item.username, masterKey),
                                password: await encrypt(item.password, masterKey),
                                notes: item.notes ? await encrypt(item.notes, masterKey) : '',
                                timestamp: item.timestamp || Date.now()
                            };
                            objectStore.add(encryptedData);
                            imported++;
                        } catch (e) {
                            console.error('Erro ao importar item:', e);
                        }
                    }
                    
                    transaction.oncomplete = () => {
                        loadPasswords();
                        alert(`‚úÖ ${imported} senhas importadas com sucesso!`);
                    };
                } catch (error) {
                    alert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // Utilit√°rios
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Inicializar ao carregar
        window.onload = async () => {
            try {
                // Inicializar banco de dados
                await initDB();
                
                // Pequeno delay para garantir que tudo carregou
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Remover tela de loading
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.classList.add('hidden');
                
                // Mostrar container
                document.querySelector('.container').classList.add('visible');
                
                // Focar no campo de senha
                setTimeout(() => {
                    document.getElementById('masterPassword').focus();
                }, 600);
                
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                
                // Mostrar erro na tela de loading
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.innerHTML = `
                    <div style="text-align: center; max-width: 400px; padding: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">‚ùå</div>
                        <div style="font-family: 'Syne', sans-serif; font-size: 1.5rem; color: #ff6b6b; margin-bottom: 10px;">
                            Erro ao Inicializar
                        </div>
                        <div style="color: var(--text-secondary); margin-bottom: 20px;">
                            N√£o foi poss√≠vel inicializar o banco de dados. 
                            Isso pode acontecer se o navegador n√£o suportar IndexedDB ou se h√° algum problema de permiss√µes.
                        </div>
                        <button class="btn" onclick="location.reload()">üîÑ Tentar Novamente</button>
                    </div>
                `;
            }
        };

        // Fechar modal ao clicar fora
        document.getElementById('passwordModal').addEventListener('click', (e) => {
            if (e.target.id === 'passwordModal') {
                closeModal();
            }
        });

        // Permitir Enter para desbloquear
        document.getElementById('masterPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                unlockVault();
            }
        });
    </script>
</body>
</html>